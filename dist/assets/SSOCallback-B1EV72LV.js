import{p as _,aO as E,y as C,s as a,a as L,aN as A,r as v,j as s,k as F,g as R,aa as B,B as N}from"./index-Dg7t10xs.js";import{u as c}from"./useMutation-CweEGHKB.js";function K(){const{user:l,session:n,role:y}=_(),d=E(),i=y==="admin",{data:f,isLoading:x,error:S,refetch:j}=C({queryKey:["sso-configs"],queryFn:async()=>{const{data:r,error:e}=await a.from("enterprise_sso_config").select("*").order("created_at",{ascending:!1});if(e)throw e;return r},enabled:i}),{data:o,isLoading:w,refetch:m}=C({queryKey:["sso-audit-logs"],queryFn:async()=>{const{data:r,error:e}=await a.from("sso_audit_logs").select("*").order("created_at",{ascending:!1}).limit(100);if(e)throw e;return r},enabled:i}),p=c({mutationFn:async r=>{const e=await a.functions.invoke("sso-initiate",{body:{email:r}});if(e.error)throw new Error(e.error.message);return e.data}}),h=c({mutationFn:async({email:r,redirectUri:e})=>{const t=await a.functions.invoke("sso-initiate",{body:{email:r,redirectUri:e}});if(t.error)throw new Error(t.error.message);return t.data}}),b=c({mutationFn:async r=>{const e=await a.functions.invoke("sso-callback",{body:r});if(e.error)throw new Error(e.error.message);return e.data}}),u=c({mutationFn:async r=>{if(!l?.id)throw new Error("Not authenticated");const{data:e,error:t}=await a.from("enterprise_sso_config").insert({...r,created_by:l.id}).select().single();if(t)throw t;return e},onSuccess:()=>{d.invalidateQueries({queryKey:["sso-configs"]})}}),k=c({mutationFn:async({id:r,updates:e})=>{const{data:t,error:g}=await a.from("enterprise_sso_config").update(e).eq("id",r).select().single();if(g)throw g;return t},onSuccess:()=>{d.invalidateQueries({queryKey:["sso-configs"]})}}),O=c({mutationFn:async r=>{const{error:e}=await a.from("enterprise_sso_config").delete().eq("id",r);if(e)throw e},onSuccess:()=>{d.invalidateQueries({queryKey:["sso-configs"]})}}),q=c({mutationFn:async({id:r,active:e})=>{const{data:t,error:g}=await a.from("enterprise_sso_config").update({active:e}).eq("id",r).select().single();if(g)throw g;return t},onSuccess:()=>{d.invalidateQueries({queryKey:["sso-configs"]})}});return{ssoConfigs:f,auditLogs:o,isLoading:x||w,error:S,isAdmin:i,checkSSOAvailability:p,initiateSSOLogin:h,handleSSOCallback:b,createSSOConfig:u,updateSSOConfig:k,deleteSSOConfig:O,toggleSSOConfig:q,refetchConfigs:j,refetchLogs:m,getSSOConfigByDomain:async r=>{const{data:e,error:t}=await a.from("enterprise_sso_config").select("*").eq("organization_domain",r).eq("active",!0).single();return t?null:e}}}const P=()=>{const l=L(),[n]=A(),{handleSSOCallback:y}=K(),{initialize:d}=_(),[i,f]=v.useState("processing"),[x,S]=v.useState("");return v.useEffect(()=>{(async()=>{try{const o=n.get("SAMLResponse"),w=n.get("RelayState"),m=n.get("code"),p=n.get("state"),h=n.get("error"),b=n.get("error_description");if(h)throw new Error(b||h);if(!o&&!m)throw new Error("Invalid SSO callback - missing required parameters");const u=await y.mutateAsync({SAMLResponse:o||void 0,RelayState:w||void 0,code:m||void 0,state:p||void 0});if(u.success)f("success"),u.redirectUrl?window.location.href=u.redirectUrl:(await d(),setTimeout(()=>{l("/dashboard",{replace:!0})},1500));else throw new Error(u.error||"SSO authentication failed")}catch(o){console.error("SSO Callback Error:",o),f("error"),S(o instanceof Error?o.message:"An unexpected error occurred")}})()},[n]),s.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 px-4",children:s.jsxs("div",{className:"w-full max-w-md text-center",children:[i==="processing"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center",children:s.jsx(F,{className:"w-8 h-8 text-blue-600 animate-spin"})}),s.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Completing Sign In"}),s.jsx("p",{className:"text-gray-600",children:"Please wait while we verify your identity..."})]}),i==="success"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center",children:s.jsx(R,{className:"w-8 h-8 text-green-600"})}),s.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Sign In Successful"}),s.jsx("p",{className:"text-gray-600",children:"Redirecting you to the dashboard..."})]}),i==="error"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center",children:s.jsx(B,{className:"w-8 h-8 text-red-600"})}),s.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Sign In Failed"}),s.jsx("p",{className:"text-red-600",children:x}),s.jsxs("div",{className:"flex flex-col gap-2 pt-4",children:[s.jsx(N,{onClick:()=>l("/auth/login"),children:"Try Again"}),s.jsx(N,{variant:"outline",onClick:()=>l("/auth/login"),children:"Back to Login"})]})]})]})})};export{P as SSOCallback,P as default};
