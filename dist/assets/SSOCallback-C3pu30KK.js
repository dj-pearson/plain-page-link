import{p as k,aR as L,z as N,x as v,s as i,a as F,aQ as A,r as j,j as s,k as R,g as Q,ac as B,B as _}from"./index-DUW0N-ya.js";import{u as c}from"./useMutation-CreKic_I.js";function K(){const{user:l,session:a,role:y}=k(),d=L(),o=y==="admin",{data:f,isLoading:x,error:S,refetch:C}=N({queryKey:["sso-configs"],queryFn:async()=>{const{data:r,error:e}=await i.from("enterprise_sso_config").select("*").order("created_at",{ascending:!1});if(e)throw e;return r},enabled:o}),{data:n,isLoading:w,refetch:m}=N({queryKey:["sso-audit-logs"],queryFn:async()=>{const{data:r,error:e}=await i.from("sso_audit_logs").select("*").order("created_at",{ascending:!1}).limit(100);if(e)throw e;return r},enabled:o}),p=c({mutationFn:async r=>{const e=await v.invoke("sso-initiate",{body:{email:r}});if(e.error)throw new Error(e.error.message);return e.data}}),h=c({mutationFn:async({email:r,redirectUri:e})=>{const t=await v.invoke("sso-initiate",{body:{email:r,redirectUri:e}});if(t.error)throw new Error(t.error.message);return t.data}}),b=c({mutationFn:async r=>{const e=await v.invoke("sso-callback",{body:r});if(e.error)throw new Error(e.error.message);return e.data}}),u=c({mutationFn:async r=>{if(!l?.id)throw new Error("Not authenticated");const{data:e,error:t}=await i.from("enterprise_sso_config").insert({...r,created_by:l.id}).select().single();if(t)throw t;return e},onSuccess:()=>{d.invalidateQueries({queryKey:["sso-configs"]})}}),q=c({mutationFn:async({id:r,updates:e})=>{const{data:t,error:g}=await i.from("enterprise_sso_config").update(e).eq("id",r).select().single();if(g)throw g;return t},onSuccess:()=>{d.invalidateQueries({queryKey:["sso-configs"]})}}),O=c({mutationFn:async r=>{const{error:e}=await i.from("enterprise_sso_config").delete().eq("id",r);if(e)throw e},onSuccess:()=>{d.invalidateQueries({queryKey:["sso-configs"]})}}),E=c({mutationFn:async({id:r,active:e})=>{const{data:t,error:g}=await i.from("enterprise_sso_config").update({active:e}).eq("id",r).select().single();if(g)throw g;return t},onSuccess:()=>{d.invalidateQueries({queryKey:["sso-configs"]})}});return{ssoConfigs:f,auditLogs:n,isLoading:x||w,error:S,isAdmin:o,checkSSOAvailability:p,initiateSSOLogin:h,handleSSOCallback:b,createSSOConfig:u,updateSSOConfig:q,deleteSSOConfig:O,toggleSSOConfig:E,refetchConfigs:C,refetchLogs:m,getSSOConfigByDomain:async r=>{const{data:e,error:t}=await i.from("enterprise_sso_config").select("*").eq("organization_domain",r).eq("active",!0).single();return t?null:e}}}const z=()=>{const l=F(),[a]=A(),{handleSSOCallback:y}=K(),{initialize:d}=k(),[o,f]=j.useState("processing"),[x,S]=j.useState("");return j.useEffect(()=>{(async()=>{try{const n=a.get("SAMLResponse"),w=a.get("RelayState"),m=a.get("code"),p=a.get("state"),h=a.get("error"),b=a.get("error_description");if(h)throw new Error(b||h);if(!n&&!m)throw new Error("Invalid SSO callback - missing required parameters");const u=await y.mutateAsync({SAMLResponse:n||void 0,RelayState:w||void 0,code:m||void 0,state:p||void 0});if(u.success)f("success"),u.redirectUrl?window.location.href=u.redirectUrl:(await d(),setTimeout(()=>{l("/dashboard",{replace:!0})},1500));else throw new Error(u.error||"SSO authentication failed")}catch(n){console.error("SSO Callback Error:",n),f("error"),S(n instanceof Error?n.message:"An unexpected error occurred")}})()},[a]),s.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 px-4",children:s.jsxs("div",{className:"w-full max-w-md text-center",children:[o==="processing"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center",children:s.jsx(R,{className:"w-8 h-8 text-blue-600 animate-spin"})}),s.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Completing Sign In"}),s.jsx("p",{className:"text-gray-600",children:"Please wait while we verify your identity..."})]}),o==="success"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center",children:s.jsx(Q,{className:"w-8 h-8 text-green-600"})}),s.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Sign In Successful"}),s.jsx("p",{className:"text-gray-600",children:"Redirecting you to the dashboard..."})]}),o==="error"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center",children:s.jsx(B,{className:"w-8 h-8 text-red-600"})}),s.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Sign In Failed"}),s.jsx("p",{className:"text-red-600",children:x}),s.jsxs("div",{className:"flex flex-col gap-2 pt-4",children:[s.jsx(_,{onClick:()=>l("/auth/login"),children:"Try Again"}),s.jsx(_,{variant:"outline",onClick:()=>l("/auth/login"),children:"Back to Login"})]})]})]})})};export{z as SSOCallback,z as default};
