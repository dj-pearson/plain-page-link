import{c as e,p as t}from"./data-O5cD9hjv.js";import{s as i}from"./supabase-BYwji6mk.js";import{u as s}from"./utils-wmY8hpgz.js";const o=e()(t((e,t)=>({user:null,session:null,profile:null,role:null,isLoading:!0,error:null,initialize:async()=>{const t=await i.auth.getSession();t.data.session?e({user:t.data.session.user,session:t.data.session,isLoading:!0}):e({isLoading:!0});try{const{data:{session:t}}=await i.auth.getSession();if(t?.user){const[s,o]=await Promise.all([i.from("profiles").select("*").eq("id",t.user.id).single(),i.from("user_roles").select("role").eq("user_id",t.user.id).order("role",{ascending:!0})]),r=o.data?.find(e=>"admin"===e.role)?.role||o.data?.[0]?.role||null;e({user:t.user,session:t,profile:s.data||null,role:r,isLoading:!1})}else e({user:null,session:null,profile:null,role:null,isLoading:!1})}catch(s){e({user:null,session:null,profile:null,role:null,isLoading:!1,error:s.message})}i.auth.onAuthStateChange(async(t,o)=>{if("SIGNED_OUT"!==t)if("TOKEN_REFRESHED"!==t)if(e({session:o,user:o?.user??null}),o?.user)try{const[t,s]=await Promise.all([i.from("profiles").select("*").eq("id",o.user.id).single(),i.from("user_roles").select("role").eq("user_id",o.user.id).order("role",{ascending:!0})]),r=s.data?.find(e=>"admin"===e.role)?.role||s.data?.[0]?.role||null;e({profile:t.data||null,role:r})}catch(s){}else e({profile:null,role:null});else e({session:o,user:o?.user??null});else e({session:null,user:null,profile:null,role:null})})},signUp:async(t,s,o,r)=>{e({isLoading:!0,error:null});try{const{data:a,error:n}=await i.auth.signUp({email:t,password:s,options:{data:{username:o,full_name:r||""},emailRedirectTo:`${window.location.origin}/`}});if(n)throw n;e({user:a.user,session:a.session,isLoading:!1})}catch(a){throw e({error:a.message,isLoading:!1}),a}},signIn:async(t,s)=>{e({isLoading:!0,error:null});try{const{data:o,error:r}=await i.auth.signInWithPassword({email:t,password:s});if(r)throw r;const{data:a}=await i.from("profiles").select("*").eq("id",o.user.id).single(),{data:n}=await i.from("user_roles").select("role").eq("user_id",o.user.id).order("role",{ascending:!0}),l=n?.find(e=>"admin"===e.role)?.role||n?.[0]?.role||null;e({user:o.user,session:o.session,profile:a||null,role:l,isLoading:!1})}catch(o){throw e({error:o.message,isLoading:!1}),o}},signOut:async()=>{e({isLoading:!0});try{await i.auth.signOut(),e({user:null,session:null,profile:null,role:null,isLoading:!1,error:null})}catch(t){e({isLoading:!1})}},updateProfile:async s=>{const{user:o}=t();if(!o)throw new Error("Not authenticated");e({isLoading:!0,error:null});try{const{data:t,error:r}=await i.from("profiles").update(s).eq("id",o.id).select().single();if(r)throw r;e({profile:t,isLoading:!1})}catch(r){throw e({error:r.message,isLoading:!1}),r}},clearError:()=>{e({error:null})}}),{name:"auth-storage",partialize:e=>({profile:e.profile,role:e.role})}));async function r(e,t){const s=await async function(e){const{data:t,error:s}=await i.from("profiles").select("*").eq("id",e).single();return s?null:t}(t);return s?{...e,title:s.full_name||s.username||e.title,subtitle:e.subtitle,description:s.bio||e.description,avatarUrl:s.avatar_url||e.avatarUrl}:e}async function a(e,t){const s=await async function(e){const{data:t,error:s}=await i.from("links").select("*").eq("user_id",e).eq("is_active",!0).order("position");return s?[]:t||[]}(t),o=function(e){return e.map(e=>{const t=function(e){const t=e.toLowerCase();return t.includes("instagram.com")?"instagram":t.includes("facebook.com")?"facebook":t.includes("twitter.com")||t.includes("x.com")?"twitter":t.includes("linkedin.com")?"linkedin":t.includes("youtube.com")?"youtube":t.includes("tiktok.com")?"tiktok":t.includes("zillow.com")?"zillow":t.includes("realtor.com")?"realtor":null}(e.url);return t?{id:e.id,platform:t,url:e.url,username:e.title}:null}).filter(e=>null!==e)}(s);return o.length>0?{...e,links:o}:e}const n=new class{createNewPage(e,t){return{id:this.generateId(),userId:e,slug:t,title:"My Link-in-Bio Page",description:"Real Estate Professional",blocks:[],theme:this.getDefaultTheme(),seo:{title:"My Link-in-Bio Page",description:"Real Estate Professional",keywords:["real estate","agent","properties"],twitterCard:"summary_large_image"},published:!1,createdAt:new Date,updatedAt:new Date}}getDefaultTheme(){return{name:"Default",preset:"modern",colors:{primary:"#2563eb",secondary:"#10b981",background:"#ffffff",text:"#1f2937",accent:"#f59e0b"},fonts:{heading:"Inter",body:"Inter"},borderRadius:"medium",spacing:"normal"}}async addBlock(e,t,i,s){const o=this.getBlockTemplate(t);if(!o)throw new Error(`Unknown block type: ${t}`);let n=o.defaultConfig;s&&(n=await async function(e,t){try{switch(e.type){case"bio":return await r(e,t);case"social":return await a(e,t);case"listings":return await async function(e){return{...e,title:"My Featured Properties",filter:"active",maxItems:6}}(e);case"contact":return await async function(e){return e}(e);default:return e}}catch(i){return e}}(o.defaultConfig,s));const l={id:this.generateId(),type:t,order:void 0!==i?i:e.blocks.length,visible:!0,config:n},c=[...e.blocks];return void 0!==i?(c.splice(i,0,l),c.forEach((e,t)=>{e.order=t})):c.push(l),{...e,blocks:c,updatedAt:new Date}}removeBlock(e,t){const i=e.blocks.filter(e=>e.id!==t).map((e,t)=>({...e,order:t}));return{...e,blocks:i,updatedAt:new Date}}updateBlock(e,t,i){const s=e.blocks.map(e=>e.id===t?{...e,config:{...e.config,...i}}:e);return{...e,blocks:s,updatedAt:new Date}}reorderBlocks(e,t,i){const s=[...e.blocks],[o]=s.splice(t,1);return s.splice(i,0,o),s.forEach((e,t)=>{e.order=t}),{...e,blocks:s,updatedAt:new Date}}toggleBlockVisibility(e,t){const i=e.blocks.map(e=>e.id===t?{...e,visible:!e.visible}:e);return{...e,blocks:i,updatedAt:new Date}}duplicateBlock(e,t){const i=e.blocks.find(e=>e.id===t);if(!i)return e;const s={...i,id:this.generateId(),order:i.order+1},o=[...e.blocks];return o.splice(i.order+1,0,s),o.forEach((e,t)=>{t>i.order&&(e.order=t)}),{...e,blocks:o,updatedAt:new Date}}getBlockTemplates(){return[{type:"bio",name:"Bio Section",description:"Your profile and introduction",icon:"User",category:"content",defaultConfig:{type:"bio",title:"Your Name",subtitle:"Real Estate Professional",description:"Helping clients find their dream homes in [Your City]. Licensed agent with [X] years of experience.",showSocialLinks:!0,showContactButton:!0}},{type:"listings",name:"Property Listings",description:"Showcase your active listings",icon:"Home",category:"content",defaultConfig:{type:"listings",title:"Featured Properties",layout:"grid",filter:"active",maxItems:6,showPrices:!0,showStatus:!0}},{type:"link",name:"Link Button",description:"Add a custom link",icon:"Link",category:"content",defaultConfig:{type:"link",title:"Click Here",url:"https://example.com",style:"button",openInNewTab:!0}},{type:"contact",name:"Contact Form",description:"Let visitors reach out",icon:"Mail",category:"engagement",defaultConfig:{type:"contact",title:"Get In Touch",fields:[{id:"name",type:"text",label:"Name",placeholder:"Your name",required:!0},{id:"email",type:"email",label:"Email",placeholder:"your@email.com",required:!0},{id:"message",type:"textarea",label:"Message",placeholder:"How can I help you?",required:!0}],submitButtonText:"Send Message",successMessage:"Thank you! I'll get back to you soon."}},{type:"social",name:"Social Links",description:"Connect on social media",icon:"Share2",category:"engagement",defaultConfig:{type:"social",title:"Follow Me",links:[],layout:"horizontal",iconSize:"medium"}},{type:"video",name:"Video",description:"Embed a video",icon:"Video",category:"media",defaultConfig:{type:"video",title:"Watch My Introduction",videoUrl:"",autoplay:!1,muted:!0}},{type:"testimonial",name:"Testimonials",description:"Client reviews",icon:"MessageSquare",category:"content",defaultConfig:{type:"testimonial",title:"What Clients Say",testimonials:[],layout:"slider"}},{type:"spacer",name:"Spacer",description:"Add vertical space",icon:"MoveVertical",category:"content",defaultConfig:{type:"spacer",height:40}},{type:"image",name:"Image",description:"Add an image",icon:"Image",category:"media",defaultConfig:{type:"image",imageUrl:"",alt:"Image",size:"medium"}},{type:"text",name:"Text Block",description:"Add custom text",icon:"Type",category:"content",defaultConfig:{type:"text",content:"Your text here...",align:"left",fontSize:"medium"}}]}getBlockTemplate(e){return this.getBlockTemplates().find(t=>t.type===e)}generateId(){return`block_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}validatePage(e){const t=[];e.slug&&""!==e.slug.trim()||t.push("Page slug is required"),e.title&&""!==e.title.trim()||t.push("Page title is required"),/^[a-z0-9-]+$/i.test(e.slug)||t.push("Page slug must contain only letters, numbers, and hyphens");const i=e.blocks.map(e=>e.id),s=new Set(i);return i.length!==s.size&&t.push("Duplicate block IDs detected"),{valid:0===t.length,errors:t}}},l=n.createNewPage.bind(n),c=n.addBlock.bind(n),d=n.removeBlock.bind(n),u=n.updateBlock.bind(n),g=n.reorderBlocks.bind(n),p=n.toggleBlockVisibility.bind(n),h=n.duplicateBlock.bind(n),m=n.getBlockTemplates.bind(n);n.validatePage.bind(n);const y=e((e,t)=>({page:null,selectedBlockId:null,isDragging:!1,history:[],historyIndex:-1,isPreviewMode:!1,isSaving:!1,setPage:t=>{e({page:t,history:[t],historyIndex:0,selectedBlockId:null})},loadPage:async e=>{try{const{data:s,error:o}=await i.from("custom_pages").select("*").eq("id",e).single();if(o)throw o;if(!s)throw new Error("Page not found");const r={id:s.id,userId:s.user_id,slug:s.slug,title:s.title,description:s.description||"",blocks:s.blocks,theme:s.theme,seo:s.seo,published:s.published,createdAt:new Date(s.created_at),updatedAt:new Date(s.updated_at)};t().setPage(r)}catch(o){throw s.error("Failed to load page"),o}},loadUserPages:async()=>{try{const{data:{user:e}}=await i.auth.getUser();if(!e)throw new Error("Not authenticated");const{data:t,error:s}=await i.from("custom_pages").select("*").eq("user_id",e.id).order("updated_at",{ascending:!1});if(s)throw s;return(t||[]).map(e=>({id:e.id,userId:e.user_id,slug:e.slug,title:e.title,description:e.description||"",blocks:e.blocks,theme:e.theme,seo:e.seo,published:e.published,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}))}catch(e){return[]}},selectBlock:t=>{e({selectedBlockId:t})},setIsDragging:t=>{e({isDragging:t})},addBlockToPage:async(o,r)=>{const{page:a,history:n,historyIndex:l}=t();if(a)try{const{data:{user:t}}=await i.auth.getUser(),s=await c(a,o,r,t?.id),d=n.slice(0,l+1);d.push(s),e({page:s,history:d,historyIndex:d.length-1,selectedBlockId:s.blocks[s.blocks.length-1]?.id})}catch(d){s.error("Failed to add block")}},removeBlockFromPage:i=>{const{page:s,history:o,historyIndex:r}=t();if(!s)return;const a=d(s,i),n=o.slice(0,r+1);n.push(a),e({page:a,history:n,historyIndex:n.length-1,selectedBlockId:null})},updateBlockConfig:(i,s)=>{const{page:o,history:r,historyIndex:a}=t();if(!o)return;const n=u(o,i,s),l=r.slice(0,a+1);l.push(n),e({page:n,history:l,historyIndex:l.length-1})},reorderPageBlocks:(i,s)=>{const{page:o,history:r,historyIndex:a}=t();if(!o)return;const n=g(o,i,s),l=r.slice(0,a+1);l.push(n),e({page:n,history:l,historyIndex:l.length-1})},toggleBlockVisible:i=>{const{page:s,history:o,historyIndex:r}=t();if(!s)return;const a=p(s,i),n=o.slice(0,r+1);n.push(a),e({page:a,history:n,historyIndex:n.length-1})},duplicatePageBlock:i=>{const{page:s,history:o,historyIndex:r}=t();if(!s)return;const a=h(s,i),n=o.slice(0,r+1);n.push(a),e({page:a,history:n,historyIndex:n.length-1})},updatePageMeta:i=>{const{page:s,history:o,historyIndex:r}=t();if(!s)return;const a={...s,...i,updatedAt:new Date},n=o.slice(0,r+1);n.push(a),e({page:a,history:n,historyIndex:n.length-1})},undo:()=>{const{history:i,historyIndex:s}=t();s>0&&e({page:i[s-1],historyIndex:s-1})},redo:()=>{const{history:i,historyIndex:s}=t();s<i.length-1&&e({page:i[s+1],historyIndex:s+1})},canUndo:()=>{const{historyIndex:e}=t();return e>0},canRedo:()=>{const{history:e,historyIndex:i}=t();return i<e.length-1},togglePreviewMode:()=>{e(e=>({isPreviewMode:!e.isPreviewMode,selectedBlockId:null}))},savePage:async()=>{const{page:o}=t();if(o){e({isSaving:!0});try{const{data:{user:e}}=await i.auth.getUser();if(!e)throw new Error("Not authenticated");const t={user_id:e.id,slug:o.slug,title:o.title,description:o.description,blocks:o.blocks,theme:o.theme,seo:o.seo,published:o.published},{data:r}=await i.from("custom_pages").select("id").eq("id",o.id).single();if(r){const{error:e}=await i.from("custom_pages").update(t).eq("id",o.id);if(e)throw e}else{const{error:e}=await i.from("custom_pages").insert({...t,id:o.id});if(e)throw e}s.success("Page saved successfully")}catch(r){throw s.error("Failed to save page"),r}finally{e({isSaving:!1})}}},publishPage:async()=>{const{page:e,updatePageMeta:i,savePage:o}=t();e&&(i({published:!0}),await o(),s.success("Page published successfully!"))},setAsActivePage:async e=>{try{const{data:{user:t}}=await i.auth.getUser();if(!t)throw new Error("Not authenticated");const{error:o}=await i.from("custom_pages").update({is_active:!0}).eq("id",e).eq("user_id",t.id);if(o)throw o;s.success("This page is now your active profile")}catch(t){throw s.error("Failed to set active page"),t}},resetBuilder:()=>{e({page:null,selectedBlockId:null,isDragging:!1,history:[],historyIndex:-1,isPreviewMode:!1,isSaving:!1})}}));export{y as a,l as c,m as g,o as u};
