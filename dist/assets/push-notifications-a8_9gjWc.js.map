{"version":3,"mappings":"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","names":["firebaseConfig","vapidKey","PushNotificationManager","initializeApp","__vitePreload","n","getMessaging","getToken","onMessage","app","payload","error","registration","newWorker","token","userId","supabase","session","notification","data","title","options","pushNotifications"],"ignoreList":[],"sources":["../../src/lib/push-notifications.ts"],"sourcesContent":["/**\n * Push Notifications Manager\n * Handles Firebase Cloud Messaging for push notifications\n */\n\n// Firebase configuration will be loaded from environment variables\nconst firebaseConfig = {\n    apiKey: import.meta.env.VITE_FIREBASE_API_KEY,\n    authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,\n    projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,\n    storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,\n    messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,\n    appId: import.meta.env.VITE_FIREBASE_APP_ID,\n};\n\nconst vapidKey = import.meta.env.VITE_FIREBASE_VAPID_KEY;\n\nexport class PushNotificationManager {\n    private static instance: PushNotificationManager;\n    private messaging: any;\n    private currentToken?: string;\n\n    private constructor() {}\n\n    static getInstance(): PushNotificationManager {\n        if (!PushNotificationManager.instance) {\n            PushNotificationManager.instance = new PushNotificationManager();\n        }\n        return PushNotificationManager.instance;\n    }\n\n    async init() {\n        // Check if Firebase is configured\n        if (!firebaseConfig.apiKey) {\n            if (import.meta.env.DEV) {\n                console.warn(\"[PushNotifications] Firebase not configured\");\n            }\n            return false;\n        }\n\n        try {\n            // Register service worker first\n            await this.registerServiceWorker();\n\n            // Dynamically import Firebase to reduce initial bundle size\n            const { initializeApp } = await import(\"firebase/app\");\n            const { getMessaging, getToken, onMessage } = await import(\n                \"firebase/messaging\"\n            );\n\n            const app = initializeApp(firebaseConfig);\n            this.messaging = getMessaging(app);\n\n            // Handle foreground messages\n            onMessage(this.messaging, (payload) => {\n                if (import.meta.env.DEV) {\n                    console.log(\n                        \"[PushNotifications] Foreground message received:\",\n                        payload\n                    );\n                }\n                this.handleForegroundMessage(payload);\n            });\n\n            return true;\n        } catch (error) {\n            console.error(\"[PushNotifications] Failed to initialize:\", error);\n            return false;\n        }\n    }\n\n    private async registerServiceWorker(): Promise<void> {\n        if (!('serviceWorker' in navigator)) {\n            console.warn('[PushNotifications] Service workers not supported');\n            return;\n        }\n\n        try {\n            const registration = await navigator.serviceWorker.register(\n                '/firebase-messaging-sw.js',\n                { scope: '/' }\n            );\n\n            if (import.meta.env.DEV) {\n                console.log('[PushNotifications] Service worker registered:', registration);\n            }\n\n            // Send Firebase config to service worker\n            if (registration.active) {\n                registration.active.postMessage({\n                    type: 'FIREBASE_CONFIG',\n                    config: firebaseConfig,\n                });\n            }\n\n            // Listen for service worker updates\n            registration.addEventListener('updatefound', () => {\n                const newWorker = registration.installing;\n                if (newWorker) {\n                    newWorker.addEventListener('statechange', () => {\n                        if (newWorker.state === 'activated') {\n                            newWorker.postMessage({\n                                type: 'FIREBASE_CONFIG',\n                                config: firebaseConfig,\n                            });\n                        }\n                    });\n                }\n            });\n        } catch (error) {\n            console.error('[PushNotifications] Service worker registration failed:', error);\n        }\n    }\n\n    async requestPermission(): Promise<boolean> {\n        try {\n            const permission = await Notification.requestPermission();\n            if (import.meta.env.DEV) {\n                console.log(\"[PushNotifications] Permission:\", permission);\n            }\n            return permission === \"granted\";\n        } catch (error) {\n            console.error(\n                \"[PushNotifications] Permission request failed:\",\n                error\n            );\n            return false;\n        }\n    }\n\n    async getToken(): Promise<string | null> {\n        if (!this.messaging) {\n            await this.init();\n            if (!this.messaging) return null;\n        }\n\n        try {\n            const { getToken } = await import(\"firebase/messaging\");\n\n            const token = await getToken(this.messaging, { vapidKey });\n\n            if (token) {\n                if (import.meta.env.DEV) {\n                    console.log(\"[PushNotifications] FCM Token:\", token);\n                }\n                this.currentToken = token;\n                return token;\n            } else {\n                if (import.meta.env.DEV) {\n                    console.log(\n                        \"[PushNotifications] No registration token available\"\n                    );\n                }\n                return null;\n            }\n        } catch (error) {\n            console.error(\"[PushNotifications] Failed to get token:\", error);\n            return null;\n        }\n    }\n\n    async registerToken(userId: string): Promise<boolean> {\n        const token = await this.getToken();\n        if (!token) return false;\n\n        try {\n            // Get Supabase session token\n            const { supabase } = await import('@/integrations/supabase/client');\n            const { data: { session } } = await supabase.auth.getSession();\n\n            if (!session?.access_token) {\n                console.error('[PushNotifications] No active session');\n                return false;\n            }\n\n            // Send token to backend\n            const response = await fetch(\"/api/v1/notifications/register\", {\n                method: \"POST\",\n                headers: {\n                    \"Content-Type\": \"application/json\",\n                    Authorization: `Bearer ${session.access_token}`,\n                },\n                body: JSON.stringify({\n                    token,\n                    userId,\n                    device: this.getDeviceInfo(),\n                }),\n            });\n\n            if (!response.ok) {\n                throw new Error(\"Failed to register token\");\n            }\n\n            if (import.meta.env.DEV) {\n                console.log(\"[PushNotifications] Token registered successfully\");\n            }\n            return true;\n        } catch (error) {\n            console.error(\n                \"[PushNotifications] Failed to register token:\",\n                error\n            );\n            return false;\n        }\n    }\n\n    async unregisterToken(): Promise<boolean> {\n        if (!this.currentToken) return true;\n\n        try {\n            // Get Supabase session token\n            const { supabase } = await import('@/integrations/supabase/client');\n            const { data: { session } } = await supabase.auth.getSession();\n\n            if (!session?.access_token) {\n                console.error('[PushNotifications] No active session');\n                return false;\n            }\n\n            const response = await fetch(\"/api/v1/notifications/unregister\", {\n                method: \"DELETE\",\n                headers: {\n                    \"Content-Type\": \"application/json\",\n                    Authorization: `Bearer ${session.access_token}`,\n                },\n                body: JSON.stringify({\n                    token: this.currentToken,\n                }),\n            });\n\n            if (!response.ok) {\n                throw new Error(\"Failed to unregister token\");\n            }\n\n            if (import.meta.env.DEV) {\n                console.log(\"[PushNotifications] Token unregistered successfully\");\n            }\n            this.currentToken = undefined;\n            return true;\n        } catch (error) {\n            console.error(\n                \"[PushNotifications] Failed to unregister token:\",\n                error\n            );\n            return false;\n        }\n    }\n\n    private handleForegroundMessage(payload: any) {\n        const { notification, data } = payload;\n\n        // Show browser notification\n        if (notification) {\n            this.showNotification(notification.title, {\n                body: notification.body,\n                icon: notification.icon || \"/icons/icon-192.png\",\n                badge: \"/icons/icon-72.png\",\n                data: data,\n                tag: data?.type || \"default\",\n                requireInteraction: data?.requireInteraction === \"true\",\n            });\n        }\n\n        // Dispatch custom event for app to handle\n        window.dispatchEvent(\n            new CustomEvent(\"push-notification\", {\n                detail: payload,\n            })\n        );\n    }\n\n    private async showNotification(\n        title: string,\n        options: NotificationOptions\n    ) {\n        if (\"Notification\" in window && Notification.permission === \"granted\") {\n            try {\n                const registration = await navigator.serviceWorker.ready;\n                await registration.showNotification(title, options);\n            } catch (error) {\n                console.error(\n                    \"[PushNotifications] Failed to show notification:\",\n                    error\n                );\n                // Fallback to browser notification\n                new Notification(title, options);\n            }\n        }\n    }\n\n    private getDeviceInfo() {\n        return {\n            userAgent: navigator.userAgent,\n            platform: navigator.platform,\n            language: navigator.language,\n            timestamp: Date.now(),\n        };\n    }\n\n    // Check if notifications are supported and permitted\n    isSupported(): boolean {\n        return \"Notification\" in window && \"serviceWorker\" in navigator;\n    }\n\n    getPermissionStatus(): NotificationPermission {\n        return Notification.permission;\n    }\n}\n\n// Export singleton instance\nexport const pushNotifications = PushNotificationManager.getInstance();\n"],"file":"push-notifications-a8_9gjWc.js"}