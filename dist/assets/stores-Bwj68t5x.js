import{c as e,p as s}from"./data-O5cD9hjv.js";import{s as r}from"./supabase-BYwji6mk.js";import{u as t}from"./utils-wmY8hpgz.js";import{d as i,t as o,r as a,u as l,a as n,b as d}from"./libs-DEoVJxQ-.js";const u=e()(s((e,s)=>({user:null,session:null,profile:null,role:null,isLoading:!0,error:null,initialize:async()=>{const s=await r.auth.getSession();s.data.session?e({user:s.data.session.user,session:s.data.session,isLoading:!0}):e({isLoading:!0});try{const{data:{session:s}}=await r.auth.getSession();if(s?.user){const[t,i]=await Promise.all([r.from("profiles").select("*").eq("id",s.user.id).single(),r.from("user_roles").select("role").eq("user_id",s.user.id).order("role",{ascending:!0})]),o=i.data?.find(e=>"admin"===e.role)?.role||i.data?.[0]?.role||null;e({user:s.user,session:s,profile:t.data||null,role:o,isLoading:!1})}else e({user:null,session:null,profile:null,role:null,isLoading:!1})}catch(t){e({user:null,session:null,profile:null,role:null,isLoading:!1,error:t.message})}r.auth.onAuthStateChange(async(s,i)=>{if("SIGNED_OUT"!==s)if("TOKEN_REFRESHED"!==s)if(e({session:i,user:i?.user??null}),i?.user)try{const[s,t]=await Promise.all([r.from("profiles").select("*").eq("id",i.user.id).single(),r.from("user_roles").select("role").eq("user_id",i.user.id).order("role",{ascending:!0})]),o=t.data?.find(e=>"admin"===e.role)?.role||t.data?.[0]?.role||null;e({profile:s.data||null,role:o})}catch(t){}else e({profile:null,role:null});else e({session:i,user:i?.user??null});else e({session:null,user:null,profile:null,role:null})})},signUp:async(s,t,i,o)=>{e({isLoading:!0,error:null});try{const{data:a,error:l}=await r.auth.signUp({email:s,password:t,options:{data:{username:i,full_name:o||""},emailRedirectTo:`${window.location.origin}/`}});if(l)throw l;e({user:a.user,session:a.session,isLoading:!1})}catch(a){throw e({error:a.message,isLoading:!1}),a}},signIn:async(s,t)=>{e({isLoading:!0,error:null});try{const{data:i,error:o}=await r.auth.signInWithPassword({email:s,password:t});if(o)throw o;const{data:a}=await r.from("profiles").select("*").eq("id",i.user.id).single(),{data:l}=await r.from("user_roles").select("role").eq("user_id",i.user.id).order("role",{ascending:!0}),n=l?.find(e=>"admin"===e.role)?.role||l?.[0]?.role||null;e({user:i.user,session:i.session,profile:a||null,role:n,isLoading:!1})}catch(i){throw e({error:i.message,isLoading:!1}),i}},signOut:async()=>{e({isLoading:!0});try{await r.auth.signOut(),e({user:null,session:null,profile:null,role:null,isLoading:!1,error:null})}catch(s){e({isLoading:!1})}},updateProfile:async t=>{const{user:i}=s();if(!i)throw new Error("Not authenticated");e({isLoading:!0,error:null});try{const{data:s,error:o}=await r.from("profiles").update(t).eq("id",i.id).select().single();if(o)throw o;e({profile:s,isLoading:!1})}catch(o){throw e({error:o.message,isLoading:!1}),o}},clearError:()=>{e({error:null})}}),{name:"auth-storage",partialize:e=>({profile:e.profile,role:e.role})})),c=e((e,s)=>({page:null,selectedBlockId:null,isDragging:!1,history:[],historyIndex:-1,isPreviewMode:!1,isSaving:!1,setPage:s=>{e({page:s,history:[s],historyIndex:0,selectedBlockId:null})},loadPage:async e=>{try{const{data:t,error:i}=await r.from("custom_pages").select("*").eq("id",e).single();if(i)throw i;if(!t)throw new Error("Page not found");const o={id:t.id,userId:t.user_id,slug:t.slug,title:t.title,description:t.description||"",blocks:t.blocks,theme:t.theme,seo:t.seo,published:t.published,createdAt:new Date(t.created_at),updatedAt:new Date(t.updated_at)};s().setPage(o)}catch(i){throw t.error("Failed to load page"),i}},loadUserPages:async()=>{try{const{data:{user:e}}=await r.auth.getUser();if(!e)throw new Error("Not authenticated");const{data:s,error:t}=await r.from("custom_pages").select("*").eq("user_id",e.id).order("updated_at",{ascending:!1});if(t)throw t;return(s||[]).map(e=>({id:e.id,userId:e.user_id,slug:e.slug,title:e.title,description:e.description||"",blocks:e.blocks,theme:e.theme,seo:e.seo,published:e.published,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}))}catch(e){return[]}},selectBlock:s=>{e({selectedBlockId:s})},setIsDragging:s=>{e({isDragging:s})},addBlockToPage:async(i,o)=>{const{page:a,history:l,historyIndex:n}=s();if(a)try{const{data:{user:s}}=await r.auth.getUser(),t=await d(a,i,o,s?.id),u=l.slice(0,n+1);u.push(t),e({page:t,history:u,historyIndex:u.length-1,selectedBlockId:t.blocks[t.blocks.length-1]?.id})}catch(u){t.error("Failed to add block")}},removeBlockFromPage:r=>{const{page:t,history:i,historyIndex:o}=s();if(!t)return;const a=n(t,r),l=i.slice(0,o+1);l.push(a),e({page:a,history:l,historyIndex:l.length-1,selectedBlockId:null})},updateBlockConfig:(r,t)=>{const{page:i,history:o,historyIndex:a}=s();if(!i)return;const n=l(i,r,t),d=o.slice(0,a+1);d.push(n),e({page:n,history:d,historyIndex:d.length-1})},reorderPageBlocks:(r,t)=>{const{page:i,history:o,historyIndex:l}=s();if(!i)return;const n=a(i,r,t),d=o.slice(0,l+1);d.push(n),e({page:n,history:d,historyIndex:d.length-1})},toggleBlockVisible:r=>{const{page:t,history:i,historyIndex:a}=s();if(!t)return;const l=o(t,r),n=i.slice(0,a+1);n.push(l),e({page:l,history:n,historyIndex:n.length-1})},duplicatePageBlock:r=>{const{page:t,history:o,historyIndex:a}=s();if(!t)return;const l=i(t,r),n=o.slice(0,a+1);n.push(l),e({page:l,history:n,historyIndex:n.length-1})},updatePageMeta:r=>{const{page:t,history:i,historyIndex:o}=s();if(!t)return;const a={...t,...r,updatedAt:new Date},l=i.slice(0,o+1);l.push(a),e({page:a,history:l,historyIndex:l.length-1})},undo:()=>{const{history:r,historyIndex:t}=s();t>0&&e({page:r[t-1],historyIndex:t-1})},redo:()=>{const{history:r,historyIndex:t}=s();t<r.length-1&&e({page:r[t+1],historyIndex:t+1})},canUndo:()=>{const{historyIndex:e}=s();return e>0},canRedo:()=>{const{history:e,historyIndex:r}=s();return r<e.length-1},togglePreviewMode:()=>{e(e=>({isPreviewMode:!e.isPreviewMode,selectedBlockId:null}))},savePage:async()=>{const{page:i}=s();if(i){e({isSaving:!0});try{const{data:{user:e}}=await r.auth.getUser();if(!e)throw new Error("Not authenticated");const s={user_id:e.id,slug:i.slug,title:i.title,description:i.description,blocks:i.blocks,theme:i.theme,seo:i.seo,published:i.published},{data:o}=await r.from("custom_pages").select("id").eq("id",i.id).single();if(o){const{error:e}=await r.from("custom_pages").update(s).eq("id",i.id);if(e)throw e}else{const{error:e}=await r.from("custom_pages").insert({...s,id:i.id});if(e)throw e}t.success("Page saved successfully")}catch(o){throw t.error("Failed to save page"),o}finally{e({isSaving:!1})}}},publishPage:async()=>{const{page:e,updatePageMeta:r,savePage:i}=s();e&&(r({published:!0}),await i(),t.success("Page published successfully!"))},setAsActivePage:async e=>{try{const{data:{user:s}}=await r.auth.getUser();if(!s)throw new Error("Not authenticated");const{error:i}=await r.from("custom_pages").update({is_active:!0}).eq("id",e).eq("user_id",s.id);if(i)throw i;t.success("This page is now your active profile")}catch(s){throw t.error("Failed to set active page"),s}},resetBuilder:()=>{e({page:null,selectedBlockId:null,isDragging:!1,history:[],historyIndex:-1,isPreviewMode:!1,isSaving:!1})}}));export{c as a,u};
