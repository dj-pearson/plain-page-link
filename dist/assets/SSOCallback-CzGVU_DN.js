import{j as e}from"./ui-vendor-DfpuNOa7.js";import{j as E,m as R,b as C}from"./react-vendor-ctj0ExSI.js";import{b as A,u as L,d as f}from"./state-vendor-BElgh7Si.js";import{a0 as F,l as q,r as N,s as S,h as M,e as T,B as k,a4 as B}from"./index-DMBvLcus.js";import"./supabase-GsKtvycU.js";import"./three-vendor-BsISVfAm.js";import"./charts-vendor-DGVahL1I.js";import"./date-vendor-Xm6TBh54.js";import"./form-vendor-Ce9oe0_k.js";import"./animation-vendor-OAo91Cux.js";const D=F("ShieldAlert",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M12 16h.01",key:"1drbdi"}]]);function K(){const{user:r,session:o,role:l}=q(),c=A(),d=l==="admin",{data:m,isLoading:g,error:i,refetch:h}=L({queryKey:["sso-configs"],queryFn:async()=>{const{data:s,error:t}=await S.from("enterprise_sso_config").select("*").order("created_at",{ascending:!1});if(t)throw t;return s},enabled:d}),{data:b,isLoading:O,refetch:u}=L({queryKey:["sso-audit-logs"],queryFn:async()=>{const{data:s,error:t}=await S.from("sso_audit_logs").select("*").order("created_at",{ascending:!1}).limit(100);if(t)throw t;return s},enabled:d}),j=f({mutationFn:async s=>{const t=await N.invoke("sso-initiate",{body:{email:s}});if(t.error)throw new Error(t.error.message);return t.data}}),y=f({mutationFn:async({email:s,redirectUri:t})=>{const a=await N.invoke("sso-initiate",{body:{email:s,redirectUri:t}});if(a.error)throw new Error(a.error.message);const n=a.data;return n.requestId&&(sessionStorage.setItem("sso_oauth_state",n.requestId),sessionStorage.setItem("sso_oauth_timestamp",Date.now().toString())),n}}),w=f({mutationFn:async s=>{const t=await N.invoke("sso-callback",{body:s});if(t.error)throw new Error(t.error.message);return t.data}}),v=f({mutationFn:async s=>{if(!r?.id)throw new Error("Not authenticated");const{data:t,error:a}=await S.from("enterprise_sso_config").insert({...s,created_by:r.id}).select().single();if(a)throw a;return t},onSuccess:()=>{c.invalidateQueries({queryKey:["sso-configs"]})}}),_=f({mutationFn:async({id:s,updates:t})=>{const{data:a,error:n}=await S.from("enterprise_sso_config").update(t).eq("id",s).select().single();if(n)throw n;return a},onSuccess:()=>{c.invalidateQueries({queryKey:["sso-configs"]})}}),x=f({mutationFn:async s=>{const{error:t}=await S.from("enterprise_sso_config").delete().eq("id",s);if(t)throw t},onSuccess:()=>{c.invalidateQueries({queryKey:["sso-configs"]})}}),p=f({mutationFn:async({id:s,active:t})=>{const{data:a,error:n}=await S.from("enterprise_sso_config").update({active:t}).eq("id",s).select().single();if(n)throw n;return a},onSuccess:()=>{c.invalidateQueries({queryKey:["sso-configs"]})}});return{ssoConfigs:m,auditLogs:b,isLoading:g||O,error:i,isAdmin:d,checkSSOAvailability:j,initiateSSOLogin:y,handleSSOCallback:w,createSSOConfig:v,updateSSOConfig:_,deleteSSOConfig:x,toggleSSOConfig:p,refetchConfigs:h,refetchLogs:u,getSSOConfigByDomain:async s=>{const{data:t,error:a}=await S.from("enterprise_sso_config").select("*").eq("organization_domain",s).eq("active",!0).single();return a?null:t},validateSSOState:s=>{const t=sessionStorage.getItem("sso_oauth_state"),a=sessionStorage.getItem("sso_oauth_timestamp");if(sessionStorage.removeItem("sso_oauth_state"),sessionStorage.removeItem("sso_oauth_timestamp"),!s||!t||s!==t)throw new Error("Invalid SSO state - possible CSRF attack detected");if(a){const n=Date.now()-parseInt(a,10),I=900*1e3;if(n>I)throw new Error("SSO request expired - please try again")}return!0},clearSSOState:()=>{sessionStorage.removeItem("sso_oauth_state"),sessionStorage.removeItem("sso_oauth_timestamp")}}}function Q(r,o=[]){try{const l=window.location.origin,c=new URL(r,window.location.origin),d=new URL(l);if(r.startsWith("/")&&!r.startsWith("//")||c.origin===d.origin||c.origin===window.location.origin)return!0;const m=c.hostname.toLowerCase();return[d.hostname.toLowerCase(),window.location.hostname.toLowerCase(),...o.map(i=>i.toLowerCase())].some(i=>{if(m===i)return!0;if(i.startsWith("*.")){const h=i.substring(2);return m.endsWith("."+h)||m===h}return!1})}catch(l){return console.error("Invalid redirect URL format:",l),!1}}function U(r,o="/dashboard",l=[]){return r?Q(r,l)?r:(console.warn(`[Security] Invalid redirect URL blocked: ${r}`),o):o}const se=()=>{const r=E(),[o]=R(),{handleSSOCallback:l,validateSSOState:c,clearSSOState:d}=K(),{initialize:m}=q(),[g,i]=C.useState("processing"),[h,b]=C.useState("");return C.useEffect(()=>{(async()=>{try{const u=o.get("SAMLResponse"),j=o.get("RelayState"),y=o.get("code"),w=o.get("state"),v=o.get("error"),_=o.get("error_description");if(v)throw d(),new Error(_||v);if(!u&&!y)throw d(),new Error("Invalid SSO callback - missing required parameters");if(y&&w)try{c(w)}catch(p){i("csrf_error"),b(p instanceof Error?p.message:"Security validation failed");return}const x=await l.mutateAsync({SAMLResponse:u||void 0,RelayState:j||void 0,code:y||void 0,state:w||void 0});if(x.success)if(i("success"),x.redirectUrl){const p=U(x.redirectUrl,"/dashboard",["*.agentbio.net","localhost:8080","127.0.0.1:8080"]);window.location.href=p}else await m(),setTimeout(()=>{r("/dashboard",{replace:!0})},1500);else throw new Error(x.error||"SSO authentication failed")}catch(u){console.error("SSO Callback Error:",u),i("error"),b(u instanceof Error?u.message:"An unexpected error occurred")}})()},[o]),e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 px-4",children:e.jsxs("div",{className:"w-full max-w-md text-center",children:[g==="processing"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(M,{className:"w-8 h-8 text-blue-600 animate-spin"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Completing Sign In"}),e.jsx("p",{className:"text-gray-600",children:"Please wait while we verify your identity..."})]}),g==="success"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx(T,{className:"w-8 h-8 text-green-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Sign In Successful"}),e.jsx("p",{className:"text-gray-600",children:"Redirecting you to the dashboard..."})]}),g==="csrf_error"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center",children:e.jsx(D,{className:"w-8 h-8 text-amber-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Security Check Failed"}),e.jsx("p",{className:"text-amber-600",children:h}),e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4 mt-4 text-left",children:[e.jsx("p",{className:"text-sm text-amber-800",children:e.jsx("strong",{children:"What happened?"})}),e.jsx("p",{className:"text-sm text-amber-700 mt-1",children:"This security check protects against cross-site request forgery attacks. This can happen if:"}),e.jsxs("ul",{className:"text-sm text-amber-700 mt-2 list-disc list-inside space-y-1",children:[e.jsx("li",{children:"The SSO request took too long (over 15 minutes)"}),e.jsx("li",{children:"You opened the login link in a different browser/tab"}),e.jsx("li",{children:"Your browser cleared session data"})]})]}),e.jsx("div",{className:"flex flex-col gap-2 pt-4",children:e.jsx(k,{onClick:()=>r("/auth/login"),children:"Try Again"})})]}),g==="error"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center",children:e.jsx(B,{className:"w-8 h-8 text-red-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Sign In Failed"}),e.jsx("p",{className:"text-red-600",children:h}),e.jsxs("div",{className:"flex flex-col gap-2 pt-4",children:[e.jsx(k,{onClick:()=>r("/auth/login"),children:"Try Again"}),e.jsx(k,{variant:"outline",onClick:()=>r("/auth/login"),children:"Back to Login"})]})]})]})})};export{se as SSOCallback,se as default};
