import{c as e,p as t}from"./data-O5cD9hjv.js";import{s,a as i}from"./supabase-DfyRWmQG.js";import{u as o}from"./utils-wmY8hpgz.js";const r=e()(t((e,t)=>({user:null,session:null,profile:null,role:null,isLoading:!0,error:null,initialize:async()=>{const t=await s.auth.getSession();t.data.session?e({user:t.data.session.user,session:t.data.session,isLoading:!0}):e({isLoading:!0});try{const{data:{session:t}}=await s.auth.getSession();if(t?.user){const[i,o]=await Promise.all([s.from("profiles").select("*").eq("id",t.user.id).single(),s.from("user_roles").select("role").eq("user_id",t.user.id).order("role",{ascending:!0})]),r=o.data?.find(e=>"admin"===e.role)?.role||o.data?.[0]?.role||null;e({user:t.user,session:t,profile:i.data||null,role:r,isLoading:!1})}else e({user:null,session:null,profile:null,role:null,isLoading:!1})}catch(i){e({user:null,session:null,profile:null,role:null,isLoading:!1,error:i.message})}s.auth.onAuthStateChange(async(t,o)=>{if("SIGNED_OUT"!==t)if("TOKEN_REFRESHED"!==t)if(e({session:o,user:o?.user??null}),o?.user)try{const[t,i]=await Promise.all([s.from("profiles").select("*").eq("id",o.user.id).single(),s.from("user_roles").select("role").eq("user_id",o.user.id).order("role",{ascending:!0})]),r=i.data?.find(e=>"admin"===e.role)?.role||i.data?.[0]?.role||null;e({profile:t.data||null,role:r})}catch(i){}else e({profile:null,role:null});else e({session:o,user:o?.user??null});else e({session:null,user:null,profile:null,role:null})})},signUp:async(t,i,o,r)=>{e({isLoading:!0,error:null});try{const{data:a,error:n}=await s.auth.signUp({email:t,password:i,options:{data:{username:o,full_name:r||""},emailRedirectTo:`${window.location.origin}/`}});if(n)throw n;e({user:a.user,session:a.session,isLoading:!1})}catch(a){throw e({error:a.message,isLoading:!1}),a}},signIn:async(t,i)=>{e({isLoading:!0,error:null});try{const{data:o,error:r}=await s.auth.signInWithPassword({email:t,password:i});if(r)throw r;const{data:a}=await s.from("profiles").select("*").eq("id",o.user.id).single(),{data:n}=await s.from("user_roles").select("role").eq("user_id",o.user.id).order("role",{ascending:!0}),l=n?.find(e=>"admin"===e.role)?.role||n?.[0]?.role||null;e({user:o.user,session:o.session,profile:a||null,role:l,isLoading:!1})}catch(o){throw e({error:o.message,isLoading:!1}),o}},signOut:async()=>{e({isLoading:!0});try{await s.auth.signOut(),e({user:null,session:null,profile:null,role:null,isLoading:!1,error:null})}catch(t){e({isLoading:!1})}},updateProfile:async i=>{const{user:o}=t();if(!o)throw new Error("Not authenticated");e({isLoading:!0,error:null});try{const{data:t,error:r}=await s.from("profiles").update(i).eq("id",o.id).select().single();if(r)throw r;e({profile:t,isLoading:!1})}catch(r){throw e({error:r.message,isLoading:!1}),r}},clearError:()=>{e({error:null})}}),{name:"auth-storage",partialize:e=>({profile:e.profile,role:e.role})}));const a=new class{createNewPage(e,t){return{id:this.generateId(),userId:e,slug:t,title:"My Link-in-Bio Page",description:"Real Estate Professional",blocks:[],theme:this.getDefaultTheme(),seo:{title:"My Link-in-Bio Page",description:"Real Estate Professional",keywords:["real estate","agent","properties"],twitterCard:"summary_large_image"},published:!1,createdAt:new Date,updatedAt:new Date}}getDefaultTheme(){return{name:"Default",preset:"modern",colors:{primary:"#2563eb",secondary:"#10b981",background:"#ffffff",text:"#1f2937",accent:"#f59e0b"},fonts:{heading:"Inter",body:"Inter"},borderRadius:"medium",spacing:"normal"}}async addBlock(e,t,s,o){const r=this.getBlockTemplate(t);if(!r)throw new Error(`Unknown block type: ${t}`);let a=r.defaultConfig;o&&(a=await i(r.defaultConfig,o));const n={id:this.generateId(),type:t,order:void 0!==s?s:e.blocks.length,visible:!0,config:a},l=[...e.blocks];return void 0!==s?(l.splice(s,0,n),l.forEach((e,t)=>{e.order=t})):l.push(n),{...e,blocks:l,updatedAt:new Date}}removeBlock(e,t){const s=e.blocks.filter(e=>e.id!==t).map((e,t)=>({...e,order:t}));return{...e,blocks:s,updatedAt:new Date}}updateBlock(e,t,s){const i=e.blocks.map(e=>e.id===t?{...e,config:{...e.config,...s}}:e);return{...e,blocks:i,updatedAt:new Date}}reorderBlocks(e,t,s){const i=[...e.blocks],[o]=i.splice(t,1);return i.splice(s,0,o),i.forEach((e,t)=>{e.order=t}),{...e,blocks:i,updatedAt:new Date}}toggleBlockVisibility(e,t){const s=e.blocks.map(e=>e.id===t?{...e,visible:!e.visible}:e);return{...e,blocks:s,updatedAt:new Date}}duplicateBlock(e,t){const s=e.blocks.find(e=>e.id===t);if(!s)return e;const i={...s,id:this.generateId(),order:s.order+1},o=[...e.blocks];return o.splice(s.order+1,0,i),o.forEach((e,t)=>{t>s.order&&(e.order=t)}),{...e,blocks:o,updatedAt:new Date}}getBlockTemplates(){return[{type:"bio",name:"Bio Section",description:"Your profile and introduction",icon:"User",category:"content",defaultConfig:{type:"bio",title:"Your Name",subtitle:"Real Estate Professional",description:"Helping clients find their dream homes in [Your City]. Licensed agent with [X] years of experience.",showSocialLinks:!0,showContactButton:!0}},{type:"listings",name:"Property Listings",description:"Showcase your active listings",icon:"Home",category:"content",defaultConfig:{type:"listings",title:"Featured Properties",layout:"grid",filter:"active",maxItems:6,showPrices:!0,showStatus:!0}},{type:"link",name:"Link Button",description:"Add a custom link",icon:"Link",category:"content",defaultConfig:{type:"link",title:"Click Here",url:"https://example.com",style:"button",openInNewTab:!0}},{type:"contact",name:"Contact Form",description:"Let visitors reach out",icon:"Mail",category:"engagement",defaultConfig:{type:"contact",title:"Get In Touch",fields:[{id:"name",type:"text",label:"Name",placeholder:"Your name",required:!0},{id:"email",type:"email",label:"Email",placeholder:"your@email.com",required:!0},{id:"message",type:"textarea",label:"Message",placeholder:"How can I help you?",required:!0}],submitButtonText:"Send Message",successMessage:"Thank you! I'll get back to you soon."}},{type:"social",name:"Social Links",description:"Connect on social media",icon:"Share2",category:"engagement",defaultConfig:{type:"social",title:"Follow Me",links:[],layout:"horizontal",iconSize:"medium"}},{type:"video",name:"Video",description:"Embed a video",icon:"Video",category:"media",defaultConfig:{type:"video",title:"Watch My Introduction",videoUrl:"",autoplay:!1,muted:!0}},{type:"testimonial",name:"Testimonials",description:"Client reviews",icon:"MessageSquare",category:"content",defaultConfig:{type:"testimonial",title:"What Clients Say",testimonials:[],layout:"slider"}},{type:"spacer",name:"Spacer",description:"Add vertical space",icon:"MoveVertical",category:"content",defaultConfig:{type:"spacer",height:40}},{type:"image",name:"Image",description:"Add an image",icon:"Image",category:"media",defaultConfig:{type:"image",imageUrl:"",alt:"Image",size:"medium"}},{type:"text",name:"Text Block",description:"Add custom text",icon:"Type",category:"content",defaultConfig:{type:"text",content:"Your text here...",align:"left",fontSize:"medium"}}]}getBlockTemplate(e){return this.getBlockTemplates().find(t=>t.type===e)}generateId(){return`block_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}validatePage(e){const t=[];e.slug&&""!==e.slug.trim()||t.push("Page slug is required"),e.title&&""!==e.title.trim()||t.push("Page title is required"),/^[a-z0-9-]+$/i.test(e.slug)||t.push("Page slug must contain only letters, numbers, and hyphens");const s=e.blocks.map(e=>e.id),i=new Set(s);return s.length!==i.size&&t.push("Duplicate block IDs detected"),{valid:0===t.length,errors:t}}},n=a.createNewPage.bind(a),l=a.addBlock.bind(a),d=a.removeBlock.bind(a),c=a.updateBlock.bind(a),u=a.reorderBlocks.bind(a),g=a.toggleBlockVisibility.bind(a),p=a.duplicateBlock.bind(a),h=a.getBlockTemplates.bind(a);a.validatePage.bind(a);const y=e((e,t)=>({page:null,selectedBlockId:null,isDragging:!1,history:[],historyIndex:-1,isPreviewMode:!1,isSaving:!1,setPage:t=>{e({page:t,history:[t],historyIndex:0,selectedBlockId:null})},loadPage:async e=>{try{const{data:i,error:o}=await s.from("custom_pages").select("*").eq("id",e).single();if(o)throw o;if(!i)throw new Error("Page not found");const r={id:i.id,userId:i.user_id,slug:i.slug,title:i.title,description:i.description||"",blocks:i.blocks,theme:i.theme,seo:i.seo,published:i.published,createdAt:new Date(i.created_at),updatedAt:new Date(i.updated_at)};t().setPage(r)}catch(i){throw o.error("Failed to load page"),i}},loadUserPages:async()=>{try{const{data:{user:e}}=await s.auth.getUser();if(!e)throw new Error("Not authenticated");const{data:t,error:i}=await s.from("custom_pages").select("*").eq("user_id",e.id).order("updated_at",{ascending:!1});if(i)throw i;return(t||[]).map(e=>({id:e.id,userId:e.user_id,slug:e.slug,title:e.title,description:e.description||"",blocks:e.blocks,theme:e.theme,seo:e.seo,published:e.published,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}))}catch(e){return[]}},selectBlock:t=>{e({selectedBlockId:t})},setIsDragging:t=>{e({isDragging:t})},addBlockToPage:async(i,r)=>{const{page:a,history:n,historyIndex:d}=t();if(a)try{const{data:{user:t}}=await s.auth.getUser(),o=await l(a,i,r,t?.id),c=n.slice(0,d+1);c.push(o),e({page:o,history:c,historyIndex:c.length-1,selectedBlockId:o.blocks[o.blocks.length-1]?.id})}catch(c){o.error("Failed to add block")}},removeBlockFromPage:s=>{const{page:i,history:o,historyIndex:r}=t();if(!i)return;const a=d(i,s),n=o.slice(0,r+1);n.push(a),e({page:a,history:n,historyIndex:n.length-1,selectedBlockId:null})},updateBlockConfig:(s,i)=>{const{page:o,history:r,historyIndex:a}=t();if(!o)return;const n=c(o,s,i),l=r.slice(0,a+1);l.push(n),e({page:n,history:l,historyIndex:l.length-1})},reorderPageBlocks:(s,i)=>{const{page:o,history:r,historyIndex:a}=t();if(!o)return;const n=u(o,s,i),l=r.slice(0,a+1);l.push(n),e({page:n,history:l,historyIndex:l.length-1})},toggleBlockVisible:s=>{const{page:i,history:o,historyIndex:r}=t();if(!i)return;const a=g(i,s),n=o.slice(0,r+1);n.push(a),e({page:a,history:n,historyIndex:n.length-1})},duplicatePageBlock:s=>{const{page:i,history:o,historyIndex:r}=t();if(!i)return;const a=p(i,s),n=o.slice(0,r+1);n.push(a),e({page:a,history:n,historyIndex:n.length-1})},updatePageMeta:s=>{const{page:i,history:o,historyIndex:r}=t();if(!i)return;const a={...i,...s,updatedAt:new Date},n=o.slice(0,r+1);n.push(a),e({page:a,history:n,historyIndex:n.length-1})},undo:()=>{const{history:s,historyIndex:i}=t();i>0&&e({page:s[i-1],historyIndex:i-1})},redo:()=>{const{history:s,historyIndex:i}=t();i<s.length-1&&e({page:s[i+1],historyIndex:i+1})},canUndo:()=>{const{historyIndex:e}=t();return e>0},canRedo:()=>{const{history:e,historyIndex:s}=t();return s<e.length-1},togglePreviewMode:()=>{e(e=>({isPreviewMode:!e.isPreviewMode,selectedBlockId:null}))},savePage:async()=>{const{page:i}=t();if(i){e({isSaving:!0});try{const{data:{user:e}}=await s.auth.getUser();if(!e)throw new Error("Not authenticated");const t={user_id:e.id,slug:i.slug,title:i.title,description:i.description,blocks:i.blocks,theme:i.theme,seo:i.seo,published:i.published},{data:r}=await s.from("custom_pages").select("id").eq("id",i.id).single();if(r){const{error:e}=await s.from("custom_pages").update(t).eq("id",i.id);if(e)throw e}else{const{error:e}=await s.from("custom_pages").insert({...t,id:i.id});if(e)throw e}o.success("Page saved successfully")}catch(r){throw o.error("Failed to save page"),r}finally{e({isSaving:!1})}}},publishPage:async()=>{const{page:e,updatePageMeta:s,savePage:i}=t();e&&(s({published:!0}),await i(),o.success("Page published successfully!"))},setAsActivePage:async e=>{try{const{data:{user:t}}=await s.auth.getUser();if(!t)throw new Error("Not authenticated");const{error:i}=await s.from("custom_pages").update({is_active:!0}).eq("id",e).eq("user_id",t.id);if(i)throw i;o.success("This page is now your active profile")}catch(t){throw o.error("Failed to set active page"),t}},resetBuilder:()=>{e({page:null,selectedBlockId:null,isDragging:!1,history:[],historyIndex:-1,isPreviewMode:!1,isSaving:!1})}}));export{y as a,n as c,h as g,r as u};
