{"version":3,"file":"useAnalytics-BzRP5yza.js","sources":["../../src/hooks/useAnalytics.ts"],"sourcesContent":["import { useQuery } from \"@tanstack/react-query\";\nimport { supabase } from \"@/integrations/supabase/client\";\nimport { useAuthStore } from \"@/stores/useAuthStore\";\n\nexport type TimeRange = '7d' | '30d' | '90d';\n\nexport function useAnalytics(timeRange: TimeRange = '30d') {\n  const { user } = useAuthStore();\n\n  // Calculate date cutoff based on time range\n  const getCutoffDate = (range: TimeRange) => {\n    const cutoffDays = { '7d': 7, '30d': 30, '90d': 90 }[range];\n    const date = new Date();\n    date.setDate(date.getDate() - cutoffDays);\n    return date.toISOString();\n  };\n\n  const cutoffDate = getCutoffDate(timeRange);\n\n  // Fetch analytics views with optimizations\n  const { data: views = [], isLoading: viewsLoading } = useQuery({\n    queryKey: [\"analytics-views\", user?.id, timeRange],\n    queryFn: async () => {\n      if (!user?.id) return [];\n\n      const { data, error } = await supabase\n        .from(\"analytics_views\")\n        .select(\"viewed_at, visitor_id, page_url, referrer\") // Only needed columns\n        .eq(\"user_id\", user.id)\n        .gte(\"viewed_at\", cutoffDate) // Filter by time range\n        .order(\"viewed_at\", { ascending: false })\n        .limit(1000); // Hard limit for safety\n\n      if (error) throw error;\n      return data;\n    },\n    enabled: !!user?.id,\n    staleTime: 5 * 60 * 1000, // 5 minutes instead of 60 seconds\n    gcTime: 10 * 60 * 1000, // 10 minutes cache time\n  });\n\n  // Fetch leads for analytics with optimizations\n  const { data: leads = [], isLoading: leadsLoading } = useQuery({\n    queryKey: [\"analytics-leads\", user?.id, timeRange],\n    queryFn: async () => {\n      if (!user?.id) return [];\n\n      const { data, error } = await supabase\n        .from(\"leads\")\n        .select(\"created_at, lead_type, status, email, phone\") // Only needed columns\n        .eq(\"user_id\", user.id)\n        .gte(\"created_at\", cutoffDate) // Filter by time range\n        .order(\"created_at\", { ascending: false })\n        .limit(500); // Hard limit for safety\n\n      if (error) throw error;\n      return data;\n    },\n    enabled: !!user?.id,\n    staleTime: 5 * 60 * 1000, // 5 minutes instead of 60 seconds\n    gcTime: 10 * 60 * 1000, // 10 minutes cache time\n  });\n\n  // Calculate stats from data\n  const stats = {\n    totalViews: views.length,\n    uniqueVisitors: new Set(views.map(v => v.visitor_id)).size,\n    totalLeads: leads.length,\n    conversionRate: views.length > 0 ? ((leads.length / views.length) * 100).toFixed(2) : \"0.00\",\n  };\n\n  // Group views by date for chart\n  const viewsByDate = views.reduce((acc: any, view: any) => {\n    const date = new Date(view.viewed_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });\n    if (!acc[date]) {\n      acc[date] = { name: date, views: 0, visitors: new Set() };\n    }\n    acc[date].views++;\n    if (view.visitor_id) {\n      acc[date].visitors.add(view.visitor_id);\n    }\n    return acc;\n  }, {});\n\n  const viewsData = Object.values(viewsByDate).map((day: any) => ({\n    name: day.name,\n    views: day.views,\n    visitors: day.visitors.size,\n  }));\n\n  // Group leads by type\n  const leadsByType = leads.reduce((acc: any, lead: any) => {\n    const type = lead.lead_type || 'contact';\n    acc[type] = (acc[type] || 0) + 1;\n    return acc;\n  }, {});\n\n  const leadsData = Object.entries(leadsByType).map(([name, value]) => ({\n    name: name.charAt(0).toUpperCase() + name.slice(1),\n    value,\n  }));\n\n  return {\n    stats,\n    viewsData,\n    leadsData,\n    recentLeads: leads.slice(0, 10),\n    isLoading: viewsLoading || leadsLoading,\n    timeRange,\n  };\n}\n"],"names":["useAnalytics","timeRange","user","useAuthStore","cutoffDate","range","cutoffDays","date","views","viewsLoading","useQuery","data","error","supabase","leads","leadsLoading","stats","v","viewsByDate","acc","view","viewsData","day","leadsByType","lead","type","leadsData","name","value"],"mappings":"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"}