import{p as k,aR as O,z as N,x as j,s as g,a as E,aQ as F,r as L,j as s,k as A,g as Q,ac as B,B as _}from"./index-CIfNOF3i.js";import{u as f}from"./useMutation-4dcsRmpl.js";function I(){const{user:t,session:n,role:c}=k(),a=O(),i=c==="admin",{data:d,isLoading:y,error:l,refetch:h}=N({queryKey:["sso-configs"],queryFn:async()=>{const{data:r,error:e}=await g.from("enterprise_sso_config").select("*").order("created_at",{ascending:!1});if(e)throw e;return r},enabled:i}),{data:u,isLoading:p,refetch:x}=N({queryKey:["sso-audit-logs"],queryFn:async()=>{const{data:r,error:e}=await g.from("sso_audit_logs").select("*").order("created_at",{ascending:!1}).limit(100);if(e)throw e;return r},enabled:i}),b=f({mutationFn:async r=>{const e=await j.invoke("sso-initiate",{body:{email:r}});if(e.error)throw new Error(e.error.message);return e.data}}),S=f({mutationFn:async({email:r,redirectUri:e})=>{const o=await j.invoke("sso-initiate",{body:{email:r,redirectUri:e}});if(o.error)throw new Error(o.error.message);return o.data}}),v=f({mutationFn:async r=>{const e=await j.invoke("sso-callback",{body:r});if(e.error)throw new Error(e.error.message);return e.data}}),m=f({mutationFn:async r=>{if(!t?.id)throw new Error("Not authenticated");const{data:e,error:o}=await g.from("enterprise_sso_config").insert({...r,created_by:t.id}).select().single();if(o)throw o;return e},onSuccess:()=>{a.invalidateQueries({queryKey:["sso-configs"]})}}),C=f({mutationFn:async({id:r,updates:e})=>{const{data:o,error:w}=await g.from("enterprise_sso_config").update(e).eq("id",r).select().single();if(w)throw w;return o},onSuccess:()=>{a.invalidateQueries({queryKey:["sso-configs"]})}}),R=f({mutationFn:async r=>{const{error:e}=await g.from("enterprise_sso_config").delete().eq("id",r);if(e)throw e},onSuccess:()=>{a.invalidateQueries({queryKey:["sso-configs"]})}}),q=f({mutationFn:async({id:r,active:e})=>{const{data:o,error:w}=await g.from("enterprise_sso_config").update({active:e}).eq("id",r).select().single();if(w)throw w;return o},onSuccess:()=>{a.invalidateQueries({queryKey:["sso-configs"]})}});return{ssoConfigs:d,auditLogs:u,isLoading:y||p,error:l,isAdmin:i,checkSSOAvailability:b,initiateSSOLogin:S,handleSSOCallback:v,createSSOConfig:m,updateSSOConfig:C,deleteSSOConfig:R,toggleSSOConfig:q,refetchConfigs:h,refetchLogs:x,getSSOConfigByDomain:async r=>{const{data:e,error:o}=await g.from("enterprise_sso_config").select("*").eq("organization_domain",r).eq("active",!0).single();return o?null:e}}}function K(t,n=[]){try{const c=window.location.origin,a=new URL(t,window.location.origin),i=new URL(c);if(t.startsWith("/")&&!t.startsWith("//")||a.origin===i.origin||a.origin===window.location.origin)return!0;const d=a.hostname.toLowerCase();return[i.hostname.toLowerCase(),window.location.hostname.toLowerCase(),...n.map(l=>l.toLowerCase())].some(l=>{if(d===l)return!0;if(l.startsWith("*.")){const h=l.substring(2);return d.endsWith("."+h)||d===h}return!1})}catch(c){return console.error("Invalid redirect URL format:",c),!1}}function U(t,n="/dashboard",c=[]){return t?K(t,c)?t:(console.warn(`[Security] Invalid redirect URL blocked: ${t}`),n):n}const W=()=>{const t=E(),[n]=F(),{handleSSOCallback:c}=I(),{initialize:a}=k(),[i,d]=L.useState("processing"),[y,l]=L.useState("");return L.useEffect(()=>{(async()=>{try{const u=n.get("SAMLResponse"),p=n.get("RelayState"),x=n.get("code"),b=n.get("state"),S=n.get("error"),v=n.get("error_description");if(S)throw new Error(v||S);if(!u&&!x)throw new Error("Invalid SSO callback - missing required parameters");const m=await c.mutateAsync({SAMLResponse:u||void 0,RelayState:p||void 0,code:x||void 0,state:b||void 0});if(m.success)if(d("success"),m.redirectUrl){const C=U(m.redirectUrl,"/dashboard",["*.agentbio.net","localhost:8080","127.0.0.1:8080"]);window.location.href=C}else await a(),setTimeout(()=>{t("/dashboard",{replace:!0})},1500);else throw new Error(m.error||"SSO authentication failed")}catch(u){console.error("SSO Callback Error:",u),d("error"),l(u instanceof Error?u.message:"An unexpected error occurred")}})()},[n]),s.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 px-4",children:s.jsxs("div",{className:"w-full max-w-md text-center",children:[i==="processing"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center",children:s.jsx(A,{className:"w-8 h-8 text-blue-600 animate-spin"})}),s.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Completing Sign In"}),s.jsx("p",{className:"text-gray-600",children:"Please wait while we verify your identity..."})]}),i==="success"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center",children:s.jsx(Q,{className:"w-8 h-8 text-green-600"})}),s.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Sign In Successful"}),s.jsx("p",{className:"text-gray-600",children:"Redirecting you to the dashboard..."})]}),i==="error"&&s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center",children:s.jsx(B,{className:"w-8 h-8 text-red-600"})}),s.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Sign In Failed"}),s.jsx("p",{className:"text-red-600",children:y}),s.jsxs("div",{className:"flex flex-col gap-2 pt-4",children:[s.jsx(_,{onClick:()=>t("/auth/login"),children:"Try Again"}),s.jsx(_,{variant:"outline",onClick:()=>t("/auth/login"),children:"Back to Login"})]})]})]})})};export{W as SSOCallback,W as default};
