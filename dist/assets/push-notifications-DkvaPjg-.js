const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CcQPhg_t.js","assets/ui-vendor-DfpuNOa7.js","assets/react-vendor-ctj0ExSI.js","assets/supabase-GsKtvycU.js","assets/three-vendor-BsISVfAm.js","assets/state-vendor-BElgh7Si.js","assets/charts-vendor-DGVahL1I.js","assets/date-vendor-Xm6TBh54.js","assets/form-vendor-Ce9oe0_k.js","assets/animation-vendor-OAo91Cux.js","assets/index-BwY-Wcib.css"])))=>i.map(i=>d[i]);
import{_ as a}from"./three-vendor-BsISVfAm.js";import"./react-vendor-ctj0ExSI.js";import"./ui-vendor-DfpuNOa7.js";import"./supabase-GsKtvycU.js";const u={apiKey:void 0,authDomain:void 0,projectId:void 0,storageBucket:void 0,messagingSenderId:void 0,appId:void 0},d=void 0;class o{static instance;messaging;currentToken;constructor(){}static getInstance(){return o.instance||(o.instance=new o),o.instance}async init(){if(!u.apiKey)return!1;try{await this.registerServiceWorker();const{initializeApp:e}=await a(async()=>{const{initializeApp:r}=await import("./firebase-vendor-DdnCOqKg.js").then(s=>s.i);return{initializeApp:r}},[]),{getMessaging:t,getToken:i,onMessage:n}=await a(async()=>{const{getMessaging:r,getToken:s,onMessage:f}=await import("./firebase-vendor-DdnCOqKg.js").then(g=>g.a);return{getMessaging:r,getToken:s,onMessage:f}},[]),c=e(u);return this.messaging=t(c),n(this.messaging,r=>{this.handleForegroundMessage(r)}),!0}catch(e){return console.error("[PushNotifications] Failed to initialize:",e),!1}}async registerServiceWorker(){if(!("serviceWorker"in navigator)){console.warn("[PushNotifications] Service workers not supported");return}try{const e=await navigator.serviceWorker.register("/firebase-messaging-sw.js",{scope:"/"});e.active&&e.active.postMessage({type:"FIREBASE_CONFIG",config:u}),e.addEventListener("updatefound",()=>{const t=e.installing;t&&t.addEventListener("statechange",()=>{t.state==="activated"&&t.postMessage({type:"FIREBASE_CONFIG",config:u})})})}catch(e){console.error("[PushNotifications] Service worker registration failed:",e)}}async requestPermission(){try{return await Notification.requestPermission()==="granted"}catch(e){return console.error("[PushNotifications] Permission request failed:",e),!1}}async getToken(){if(!this.messaging&&(await this.init(),!this.messaging))return null;try{const{getToken:e}=await a(async()=>{const{getToken:i}=await import("./firebase-vendor-DdnCOqKg.js").then(n=>n.a);return{getToken:i}},[]),t=await e(this.messaging,{vapidKey:d});return t?(this.currentToken=t,t):null}catch(e){return console.error("[PushNotifications] Failed to get token:",e),null}}async registerToken(e){const t=await this.getToken();if(!t)return!1;try{const{supabase:i}=await a(async()=>{const{supabase:r}=await import("./index-CcQPhg_t.js").then(s=>s.aP);return{supabase:r}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),{data:{session:n}}=await i.auth.getSession();if(!n?.access_token)return console.error("[PushNotifications] No active session"),!1;if(!(await fetch("/api/v1/notifications/register",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.access_token}`},body:JSON.stringify({token:t,userId:e,device:this.getDeviceInfo()})})).ok)throw new Error("Failed to register token");return!0}catch(i){return console.error("[PushNotifications] Failed to register token:",i),!1}}async unregisterToken(){if(!this.currentToken)return!0;try{const{supabase:e}=await a(async()=>{const{supabase:n}=await import("./index-CcQPhg_t.js").then(c=>c.aP);return{supabase:n}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),{data:{session:t}}=await e.auth.getSession();if(!t?.access_token)return console.error("[PushNotifications] No active session"),!1;if(!(await fetch("/api/v1/notifications/unregister",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`},body:JSON.stringify({token:this.currentToken})})).ok)throw new Error("Failed to unregister token");return this.currentToken=void 0,!0}catch(e){return console.error("[PushNotifications] Failed to unregister token:",e),!1}}handleForegroundMessage(e){const{notification:t,data:i}=e;t&&this.showNotification(t.title,{body:t.body,icon:t.icon||"/icons/icon-192.png",badge:"/icons/icon-72.png",data:i,tag:i?.type||"default",requireInteraction:i?.requireInteraction==="true"}),window.dispatchEvent(new CustomEvent("push-notification",{detail:e}))}async showNotification(e,t){if("Notification"in window&&Notification.permission==="granted")try{await(await navigator.serviceWorker.ready).showNotification(e,t)}catch(i){console.error("[PushNotifications] Failed to show notification:",i),new Notification(e,t)}}getDeviceInfo(){return{userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,timestamp:Date.now()}}isSupported(){return"Notification"in window&&"serviceWorker"in navigator}getPermissionStatus(){return Notification.permission}}const k=o.getInstance();export{o as PushNotificationManager,k as pushNotifications};
