import{u as e}from"./data-Hz84gFTE.js";import{u as t,s as i}from"./index-CbjSOmPL.js";function a(a="30d"){const{user:s}=t(),r=(e=>{const t={"7d":7,"30d":30,"90d":90}[e],i=new Date;return i.setDate(i.getDate()-t),i.toISOString()})(a),{data:n=[],isLoading:d}=e({queryKey:["analytics-views",null==s?void 0:s.id,a],queryFn:async()=>{if(!(null==s?void 0:s.id))return[];const{data:e,error:t}=await i.from("analytics_views").select("viewed_at, visitor_id, page_url, referrer").eq("user_id",s.id).gte("viewed_at",r).order("viewed_at",{ascending:!1}).limit(1e3);if(t)throw t;return e},enabled:!!(null==s?void 0:s.id),staleTime:3e5,gcTime:6e5}),{data:o=[],isLoading:l}=e({queryKey:["analytics-leads",null==s?void 0:s.id,a],queryFn:async()=>{if(!(null==s?void 0:s.id))return[];const{data:e,error:t}=await i.from("leads").select("created_at, lead_type, status, email, phone").eq("user_id",s.id).gte("created_at",r).order("created_at",{ascending:!1}).limit(500);if(t)throw t;return e},enabled:!!(null==s?void 0:s.id),staleTime:3e5,gcTime:6e5}),c={totalViews:n.length,uniqueVisitors:new Set(n.map(e=>e.visitor_id)).size,totalLeads:o.length,conversionRate:n.length>0?(o.length/n.length*100).toFixed(2):"0.00"},u=n.reduce((e,t)=>{const i=new Date(t.viewed_at).toLocaleDateString("en-US",{month:"short",day:"numeric"});return e[i]||(e[i]={name:i,views:0,visitors:new Set}),e[i].views++,t.visitor_id&&e[i].visitors.add(t.visitor_id),e},{}),v=Object.values(u).map(e=>({name:e.name,views:e.views,visitors:e.visitors.size})),m=o.reduce((e,t)=>{const i=t.lead_type||"contact";return e[i]=(e[i]||0)+1,e},{});return{stats:c,viewsData:v,leadsData:Object.entries(m).map(([e,t])=>({name:e.charAt(0).toUpperCase()+e.slice(1),value:t})),recentLeads:o.slice(0,10),isLoading:d||l,timeRange:a}}export{a as u};
